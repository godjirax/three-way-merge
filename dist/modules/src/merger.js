import { Resolved, Conflicted } from './outcomes';
import Diff3, { ChangeType } from './diff3';
import Diff2, { Action } from './heckel-diff';
export default class Merger {
    static merge(left, base, right) {
        const merger = new Merger(left, base, right);
        merger.executeThreeWayMerge();
        return merger.result;
    }
    constructor(left, base, right) {
        this.result = [];
        this.text3 = new Text3(left, base, right);
    }
    executeThreeWayMerge() {
        const differences = Diff3.executeDiff(this.text3.left, this.text3.base, this.text3.right);
        let index = 1;
        differences.forEach((difference) => {
            let initialText = [];
            for (let lineno = index; lineno < difference.baseLo; lineno++) {
                initialText.push(this.text3.base[lineno - 1]);
            }
            if (initialText.length) {
                this.result.push(new Resolved(initialText));
            }
            this.interpretChunk(difference);
            index = difference.baseHi + 1;
        });
        const endingText = this.accumulateLines(index, this.text3.base.length, this.text3.base);
        if (endingText.length) {
            this.result.push(new Resolved(endingText));
        }
    }
    setConflict(difference) {
        const conflict = Conflicted.create({
            left: this.accumulateLines(difference.leftLo, difference.leftHi, this.text3.left),
            base: this.accumulateLines(difference.baseLo, difference.baseHi, this.text3.base),
            right: this.accumulateLines(difference.rightLo, difference.rightHi, this.text3.right)
        });
        this.result.push(conflict);
    }
    determineConflict(d, left, right) {
        let ia = 1;
        d.forEach((changeRange) => {
            for (let lineno = ia; lineno <= changeRange.leftLo; lineno++) {
                this.result.push(new Resolved(this.accumulateLines(ia, lineno, right)));
            }
            const outcome = this.determineOutcome(changeRange, left, right);
            ia = changeRange.rightHi + 1;
            if (outcome) {
                this.result.push(outcome);
            }
        });
        let finalText = this.accumulateLines(ia, right.length + 1, right);
        if (finalText.length) {
            this.result.push(new Resolved(finalText));
        }
    }
    determineOutcome(changeRange, left, right) {
        if (changeRange.action === Action.change) {
            return Conflicted.create({
                left: this.accumulateLines(changeRange.rightLo, changeRange.rightHi, left),
                right: this.accumulateLines(changeRange.leftLo, changeRange.leftHi, right),
                base: []
            });
        }
        else if (changeRange.action === Action.add) {
            return new Resolved(this.accumulateLines(changeRange.rightLo, changeRange.rightHi, left));
        }
        else {
            return null;
        }
    }
    setText(origText, lo, hi) {
        let text = [];
        for (let i = lo; i <= hi; i++) {
            text.push(origText[i - 1]);
        }
        return text;
    }
    _conflictRange(difference) {
        const right = this.setText(this.text3.right, difference.rightLo, difference.rightHi);
        const left = this.setText(this.text3.left, difference.leftLo, difference.leftHi);
        const d = Diff2.diff(right, left);
        if ((this._assocRange(d, Action.change) || this._assocRange(d, Action.remove)) &&
            difference.baseLo <= difference.baseHi) {
            this.setConflict(difference);
        }
        else {
            this.determineConflict(d, left, right);
        }
    }
    interpretChunk(difference) {
        if (difference.changeType == ChangeType.chooseLeft) {
            const tempText = this.accumulateLines(difference.leftLo, difference.leftHi, this.text3.left);
            if (tempText.length) {
                this.result.push(new Resolved(tempText));
            }
        }
        else if (difference.changeType !== ChangeType.possibleConflict) {
            const tempText = this.accumulateLines(difference.rightLo, difference.rightHi, this.text3.right);
            if (tempText.length) {
                this.result.push(new Resolved(tempText));
            }
        }
        else {
            this._conflictRange(difference);
        }
    }
    _assocRange(diff, action) {
        for (let i = 0; i < diff.length; i++) {
            let d = diff[i];
            if (d.action === action) {
                return d;
            }
        }
        return null;
    }
    accumulateLines(lo, hi, text) {
        let lines = [];
        for (let lineno = lo; lineno <= hi; lineno++) {
            if (text[lineno - 1]) {
                lines.push(text[lineno - 1]);
            }
        }
        return lines;
    }
}
export class Text3 {
    constructor(left, base, right) {
        this.left = left;
        this.base = base;
        this.right = right;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVyZ2VyLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9rZXZpbi90cmF2YWlsL2RldngvdGhyZWUtd2F5LW1lcmdlLyIsInNvdXJjZXMiOlsibWVyZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFXLE1BQU0sWUFBWSxDQUFDO0FBQzNELE9BQU8sS0FBSyxFQUFFLEVBQWMsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3hELE9BQU8sS0FBSyxFQUFFLEVBQWUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNELE1BQU0sQ0FBQyxPQUFPO0lBQ1osTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFjLEVBQUUsSUFBYyxFQUFFLEtBQWU7UUFDMUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM3QyxNQUFNLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUU5QixPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDdkIsQ0FBQztJQUtELFlBQVksSUFBYyxFQUFFLElBQWMsRUFBRSxLQUFlO1FBQ3pELElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsb0JBQW9CO1FBQ2xCLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4RCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFFZCxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDakMsSUFBSSxX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TUFBTTtJQUNKLFlBQW1CLElBQWMsRUFDZCxJQUFjLEVBQ2QsS0FBZTtRQUZmLFNBQUksR0FBSixJQUFJLENBQVU7UUFDZCxTQUFJLEdBQUosSUFBSSxDQUFVO1FBQ2QsVUFBSyxHQUFMLEtBQUssQ0FBVTtJQUNsQyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXNvbHZlZCwgQ29uZmxpY3RlZCwgT3V0Y29tZSB9IGZyb20gJy4vb3V0Y29tZXMnO1xuaW1wb3J0IERpZmYzLCB7IERpZmZlcmVuY2UsIENoYW5nZVR5cGUgfSBmcm9tICcuL2RpZmYzJztcbmltcG9ydCBEaWZmMiwgeyBDaGFuZ2VSYW5nZSwgQWN0aW9uIH0gZnJvbSAnLi9oZWNrZWwtZGlmZic7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1lcmdlciB7XG4gIHN0YXRpYyBtZXJnZShsZWZ0OiBzdHJpbmdbXSwgYmFzZTogc3RyaW5nW10sIHJpZ2h0OiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IG1lcmdlciA9IG5ldyBNZXJnZXIobGVmdCwgYmFzZSwgcmlnaHQpO1xuICAgIG1lcmdlci5leGVjdXRlVGhyZWVXYXlNZXJnZSgpO1xuXG4gICAgcmV0dXJuIG1lcmdlci5yZXN1bHQ7XG4gIH1cblxuICByZXN1bHQ6IE91dGNvbWVbXTtcbiAgdGV4dDM6IFRleHQzO1xuXG4gIGNvbnN0cnVjdG9yKGxlZnQ6IHN0cmluZ1tdLCBiYXNlOiBzdHJpbmdbXSwgcmlnaHQ6IHN0cmluZ1tdKSB7XG4gICAgdGhpcy5yZXN1bHQgPSBbXTtcbiAgICB0aGlzLnRleHQzID0gbmV3IFRleHQzKGxlZnQsIGJhc2UsIHJpZ2h0KTtcbiAgfVxuXG4gIGV4ZWN1dGVUaHJlZVdheU1lcmdlKCkge1xuICAgIGNvbnN0IGRpZmZlcmVuY2VzID0gRGlmZjMuZXhlY3V0ZURpZmYodGhpcy50ZXh0My5sZWZ0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0My5iYXNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0My5yaWdodCk7XG4gICAgbGV0IGluZGV4ID0gMTtcblxuICAgIGRpZmZlcmVuY2VzLmZvckVhY2goKGRpZmZlcmVuY2UpID0+IHtcbiAgICAgIGxldCBpbml0aWFsVGV4dCA9IFtdO1xuXG4gICAgICBmb3IobGV0IGxpbmVubyA9IGluZGV4OyBsaW5lbm8gPCBkaWZmZXJlbmNlLmJhc2VMbzsgbGluZW5vKyspIHtcbiAgICAgICAgaW5pdGlhbFRleHQucHVzaCh0aGlzLnRleHQzLmJhc2VbbGluZW5vIC0gMV0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoaW5pdGlhbFRleHQubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMucmVzdWx0LnB1c2gobmV3IFJlc29sdmVkKGluaXRpYWxUZXh0KSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuaW50ZXJwcmV0Q2h1bmsoZGlmZmVyZW5jZSk7XG4gICAgICBpbmRleCA9IGRpZmZlcmVuY2UuYmFzZUhpICsgMTtcbiAgICB9KTtcblxuXG4gICAgY29uc3QgZW5kaW5nVGV4dCA9IHRoaXMuYWNjdW11bGF0ZUxpbmVzKGluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHQzLmJhc2UubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHQzLmJhc2UpO1xuICAgIGlmIChlbmRpbmdUZXh0Lmxlbmd0aCkge1xuICAgICAgdGhpcy5yZXN1bHQucHVzaChuZXcgUmVzb2x2ZWQoZW5kaW5nVGV4dCkpO1xuICAgIH1cbiAgfVxuXG4gIHNldENvbmZsaWN0KGRpZmZlcmVuY2U6IERpZmZlcmVuY2UpIHtcbiAgICBjb25zdCBjb25mbGljdCA9IENvbmZsaWN0ZWQuY3JlYXRlKHtcbiAgICAgIGxlZnQ6IHRoaXMuYWNjdW11bGF0ZUxpbmVzKGRpZmZlcmVuY2UubGVmdExvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZmVyZW5jZS5sZWZ0SGksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHQzLmxlZnQpLFxuICAgICAgYmFzZTogdGhpcy5hY2N1bXVsYXRlTGluZXMoZGlmZmVyZW5jZS5iYXNlTG8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlLmJhc2VIaSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dDMuYmFzZSksXG4gICAgICByaWdodDogdGhpcy5hY2N1bXVsYXRlTGluZXMoZGlmZmVyZW5jZS5yaWdodExvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZlcmVuY2UucmlnaHRIaSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHQzLnJpZ2h0KVxuICAgIH0pO1xuICAgIHRoaXMucmVzdWx0LnB1c2goY29uZmxpY3QpO1xuICB9XG5cbiAgZGV0ZXJtaW5lQ29uZmxpY3QoZDogQ2hhbmdlUmFuZ2VbXSwgbGVmdDogc3RyaW5nW10sIHJpZ2h0OiBzdHJpbmdbXSkge1xuICAgIGxldCBpYSA9IDE7XG4gICAgZC5mb3JFYWNoKChjaGFuZ2VSYW5nZSkgPT4ge1xuICAgICAgZm9yKGxldCBsaW5lbm8gPSBpYTsgbGluZW5vIDw9IGNoYW5nZVJhbmdlLmxlZnRMbzsgbGluZW5vKyspIHtcbiAgICAgICAgdGhpcy5yZXN1bHQucHVzaChuZXcgUmVzb2x2ZWQodGhpcy5hY2N1bXVsYXRlTGluZXMoaWEsIGxpbmVubywgcmlnaHQpKSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG91dGNvbWUgPSB0aGlzLmRldGVybWluZU91dGNvbWUoY2hhbmdlUmFuZ2UsIGxlZnQsIHJpZ2h0KTtcbiAgICAgIGlhID0gY2hhbmdlUmFuZ2UucmlnaHRIaSArIDE7XG4gICAgICBpZiAob3V0Y29tZSkge1xuICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKG91dGNvbWUpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbGV0IGZpbmFsVGV4dCA9IHRoaXMuYWNjdW11bGF0ZUxpbmVzKGlhLCByaWdodC5sZW5ndGggKyAxLCByaWdodCk7XG4gICAgaWYgKGZpbmFsVGV4dC5sZW5ndGgpIHtcbiAgICAgIHRoaXMucmVzdWx0LnB1c2gobmV3IFJlc29sdmVkKGZpbmFsVGV4dCkpO1xuICAgIH1cbiAgfVxuXG4gIGRldGVybWluZU91dGNvbWUoY2hhbmdlUmFuZ2U6IENoYW5nZVJhbmdlLCBsZWZ0OiBzdHJpbmdbXSwgcmlnaHQ6IHN0cmluZ1tdKSA6IE91dGNvbWUgfCBudWxsIHtcbiAgICBpZiAoY2hhbmdlUmFuZ2UuYWN0aW9uID09PSBBY3Rpb24uY2hhbmdlKSB7XG4gICAgICByZXR1cm4gQ29uZmxpY3RlZC5jcmVhdGUoe1xuICAgICAgICBsZWZ0OiB0aGlzLmFjY3VtdWxhdGVMaW5lcyhjaGFuZ2VSYW5nZS5yaWdodExvLCBjaGFuZ2VSYW5nZS5yaWdodEhpLCBsZWZ0KSxcbiAgICAgICAgcmlnaHQ6IHRoaXMuYWNjdW11bGF0ZUxpbmVzKGNoYW5nZVJhbmdlLmxlZnRMbywgY2hhbmdlUmFuZ2UubGVmdEhpLCByaWdodCksXG4gICAgICAgIGJhc2U6IFtdXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGNoYW5nZVJhbmdlLmFjdGlvbiA9PT0gQWN0aW9uLmFkZCkge1xuICAgICAgcmV0dXJuIG5ldyBSZXNvbHZlZCh0aGlzLmFjY3VtdWxhdGVMaW5lcyhjaGFuZ2VSYW5nZS5yaWdodExvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VSYW5nZS5yaWdodEhpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHNldFRleHQob3JpZ1RleHQ6IHN0cmluZ1tdLCBsbzogbnVtYmVyLCBoaTogbnVtYmVyKSB7XG4gICAgbGV0IHRleHQgPSBbXTtcbiAgICBmb3IobGV0IGkgPSBsbzsgaSA8PSBoaTsgaSsrKSB7XG4gICAgICB0ZXh0LnB1c2gob3JpZ1RleHRbaSAtIDFdKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGV4dDtcbiAgfVxuXG4gIF9jb25mbGljdFJhbmdlKGRpZmZlcmVuY2U6IERpZmZlcmVuY2UpIHtcbiAgICBjb25zdCByaWdodCA9IHRoaXMuc2V0VGV4dCh0aGlzLnRleHQzLnJpZ2h0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZlcmVuY2UucmlnaHRMbyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlLnJpZ2h0SGkpO1xuICAgIGNvbnN0IGxlZnQgPSB0aGlzLnNldFRleHQodGhpcy50ZXh0My5sZWZ0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZmVyZW5jZS5sZWZ0TG8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlLmxlZnRIaSk7XG4gICAgY29uc3QgZCA9IERpZmYyLmRpZmYocmlnaHQsIGxlZnQpO1xuICAgIGlmICgodGhpcy5fYXNzb2NSYW5nZShkLCBBY3Rpb24uY2hhbmdlKSB8fCB0aGlzLl9hc3NvY1JhbmdlKGQsIEFjdGlvbi5yZW1vdmUpKSAmJlxuICAgICAgICBkaWZmZXJlbmNlLmJhc2VMbyA8PSBkaWZmZXJlbmNlLmJhc2VIaSkge1xuICAgICAgdGhpcy5zZXRDb25mbGljdChkaWZmZXJlbmNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kZXRlcm1pbmVDb25mbGljdChkLCBsZWZ0LCByaWdodCk7XG4gICAgfVxuICB9XG5cbiAgaW50ZXJwcmV0Q2h1bmsoZGlmZmVyZW5jZTogRGlmZmVyZW5jZSkge1xuICAgIGlmIChkaWZmZXJlbmNlLmNoYW5nZVR5cGUgPT0gQ2hhbmdlVHlwZS5jaG9vc2VMZWZ0KSB7XG4gICAgICBjb25zdCB0ZW1wVGV4dCA9IHRoaXMuYWNjdW11bGF0ZUxpbmVzKGRpZmZlcmVuY2UubGVmdExvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlLmxlZnRIaSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0My5sZWZ0KTtcbiAgICAgIGlmICh0ZW1wVGV4dC5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5yZXN1bHQucHVzaChuZXcgUmVzb2x2ZWQodGVtcFRleHQpKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGRpZmZlcmVuY2UuY2hhbmdlVHlwZSAhPT0gQ2hhbmdlVHlwZS5wb3NzaWJsZUNvbmZsaWN0KSB7XG4gICAgICBjb25zdCB0ZW1wVGV4dCA9IHRoaXMuYWNjdW11bGF0ZUxpbmVzKGRpZmZlcmVuY2UucmlnaHRMbyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZmVyZW5jZS5yaWdodEhpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHQzLnJpZ2h0KTtcbiAgICAgIGlmICh0ZW1wVGV4dC5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5yZXN1bHQucHVzaChuZXcgUmVzb2x2ZWQodGVtcFRleHQpKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fY29uZmxpY3RSYW5nZShkaWZmZXJlbmNlKTtcbiAgICB9XG4gIH1cblxuICBfYXNzb2NSYW5nZShkaWZmOiBDaGFuZ2VSYW5nZVtdLCBhY3Rpb246IEFjdGlvbikge1xuICAgIGZvcihsZXQgaSA9IDA7IGkgPCBkaWZmLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgZCA9IGRpZmZbaV07XG4gICAgICBpZiAoZC5hY3Rpb24gPT09IGFjdGlvbikge1xuICAgICAgICByZXR1cm4gZDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGFjY3VtdWxhdGVMaW5lcyhsbzogbnVtYmVyLCBoaTogbnVtYmVyLCB0ZXh0OiBzdHJpbmdbXSkge1xuICAgIGxldCBsaW5lcyA9IFtdO1xuICAgIGZvcihsZXQgbGluZW5vID0gbG87IGxpbmVubyA8PSBoaTsgbGluZW5vKyspIHtcbiAgICAgIGlmICh0ZXh0W2xpbmVuby0xXSkge1xuICAgICAgICBsaW5lcy5wdXNoKHRleHRbbGluZW5vLTFdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGxpbmVzO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZXh0MyB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBsZWZ0OiBzdHJpbmdbXSxcbiAgICAgICAgICAgICAgcHVibGljIGJhc2U6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICBwdWJsaWMgcmlnaHQ6IHN0cmluZ1tdKSB7XG4gIH1cbn1cbiJdfQ==