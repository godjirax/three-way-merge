"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const outcomes_1 = require("./outcomes");
const diff3_1 = require("./diff3");
const heckel_diff_1 = require("./heckel-diff");
class Merger {
    static merge(left, base, right) {
        const merger = new Merger(left, base, right);
        merger.executeThreeWayMerge();
        return merger.result;
    }
    constructor(left, base, right) {
        this.result = [];
        this.text3 = new Text3(left, base, right);
    }
    executeThreeWayMerge() {
        const differences = diff3_1.default.executeDiff(this.text3.left, this.text3.base, this.text3.right);
        let index = 1;
        differences.forEach((difference) => {
            let initialText = [];
            for (let lineno = index; lineno < difference.baseLo; lineno++) {
                initialText.push(this.text3.base[lineno - 1]);
            }
            if (initialText.length) {
                this.result.push(new outcomes_1.Resolved(initialText));
            }
            this.interpretChunk(difference);
            index = difference.baseHi + 1;
        });
        const endingText = this.accumulateLines(index, this.text3.base.length, this.text3.base);
        if (endingText.length) {
            this.result.push(new outcomes_1.Resolved(endingText));
        }
    }
    setConflict(difference) {
        const conflict = outcomes_1.Conflicted.create({
            left: this.accumulateLines(difference.leftLo, difference.leftHi, this.text3.left),
            base: this.accumulateLines(difference.baseLo, difference.baseHi, this.text3.base),
            right: this.accumulateLines(difference.rightLo, difference.rightHi, this.text3.right)
        });
        this.result.push(conflict);
    }
    determineConflict(d, left, right) {
        let ia = 1;
        d.forEach((changeRange) => {
            for (let lineno = ia; lineno <= changeRange.leftLo; lineno++) {
                this.result.push(new outcomes_1.Resolved(this.accumulateLines(ia, lineno, right)));
            }
            const outcome = this.determineOutcome(changeRange, left, right);
            ia = changeRange.rightHi + 1;
            if (outcome) {
                this.result.push(outcome);
            }
        });
        let finalText = this.accumulateLines(ia, right.length + 1, right);
        if (finalText.length) {
            this.result.push(new outcomes_1.Resolved(finalText));
        }
    }
    determineOutcome(changeRange, left, right) {
        if (changeRange.action === heckel_diff_1.Action.change) {
            return outcomes_1.Conflicted.create({
                left: this.accumulateLines(changeRange.rightLo, changeRange.rightHi, left),
                right: this.accumulateLines(changeRange.leftLo, changeRange.leftHi, right),
                base: []
            });
        }
        else if (changeRange.action === heckel_diff_1.Action.add) {
            return new outcomes_1.Resolved(this.accumulateLines(changeRange.rightLo, changeRange.rightHi, left));
        }
        else {
            return null;
        }
    }
    setText(origText, lo, hi) {
        let text = [];
        for (let i = lo; i <= hi; i++) {
            text.push(origText[i - 1]);
        }
        return text;
    }
    _conflictRange(difference) {
        const right = this.setText(this.text3.right, difference.rightLo, difference.rightHi);
        const left = this.setText(this.text3.left, difference.leftLo, difference.leftHi);
        const d = heckel_diff_1.default.diff(right, left);
        if ((this._assocRange(d, heckel_diff_1.Action.change) || this._assocRange(d, heckel_diff_1.Action.remove)) &&
            difference.baseLo <= difference.baseHi) {
            this.setConflict(difference);
        }
        else {
            this.determineConflict(d, left, right);
        }
    }
    interpretChunk(difference) {
        if (difference.changeType == diff3_1.ChangeType.chooseLeft) {
            const tempText = this.accumulateLines(difference.leftLo, difference.leftHi, this.text3.left);
            if (tempText.length) {
                this.result.push(new outcomes_1.Resolved(tempText));
            }
        }
        else if (difference.changeType !== diff3_1.ChangeType.possibleConflict) {
            const tempText = this.accumulateLines(difference.rightLo, difference.rightHi, this.text3.right);
            if (tempText.length) {
                this.result.push(new outcomes_1.Resolved(tempText));
            }
        }
        else {
            this._conflictRange(difference);
        }
    }
    _assocRange(diff, action) {
        for (let i = 0; i < diff.length; i++) {
            let d = diff[i];
            if (d.action === action) {
                return d;
            }
        }
        return null;
    }
    accumulateLines(lo, hi, text) {
        let lines = [];
        for (let lineno = lo; lineno <= hi; lineno++) {
            if (text[lineno - 1]) {
                lines.push(text[lineno - 1]);
            }
        }
        return lines;
    }
}
exports.default = Merger;
class Text3 {
    constructor(left, base, right) {
        this.left = left;
        this.base = base;
        this.right = right;
    }
}
exports.Text3 = Text3;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVyZ2VyLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9rZXZpbi90cmF2YWlsL2RldngvdGhyZWUtd2F5LW1lcmdlLyIsInNvdXJjZXMiOlsibWVyZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQTJEO0FBQzNELG1DQUF3RDtBQUN4RCwrQ0FBMkQ7QUFFM0Q7SUFDRSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQWMsRUFBRSxJQUFjLEVBQUUsS0FBZTtRQUMxRCxNQUFNLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdDLE1BQU0sQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRTlCLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBS0QsWUFBWSxJQUFjLEVBQUUsSUFBYyxFQUFFLEtBQWU7UUFDekQsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCxvQkFBb0I7UUFDbEIsTUFBTSxXQUFXLEdBQUcsZUFBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3hELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztRQUVkLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUNqQyxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUM7WUFFckIsS0FBSSxJQUFJLE1BQU0sR0FBRyxLQUFLLEVBQUUsTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUU7Z0JBQzVELFdBQVcsQ0FBQyxJQUFJLENBQUMs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QUwsS0FBSyxDQUFVO0lBQ2xDLENBQUM7Q0FDRjtBQUxELHNCQUtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVzb2x2ZWQsIENvbmZsaWN0ZWQsIE91dGNvbWUgfSBmcm9tICcuL291dGNvbWVzJztcbmltcG9ydCBEaWZmMywgeyBEaWZmZXJlbmNlLCBDaGFuZ2VUeXBlIH0gZnJvbSAnLi9kaWZmMyc7XG5pbXBvcnQgRGlmZjIsIHsgQ2hhbmdlUmFuZ2UsIEFjdGlvbiB9IGZyb20gJy4vaGVja2VsLWRpZmYnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNZXJnZXIge1xuICBzdGF0aWMgbWVyZ2UobGVmdDogc3RyaW5nW10sIGJhc2U6IHN0cmluZ1tdLCByaWdodDogc3RyaW5nW10pIHtcbiAgICBjb25zdCBtZXJnZXIgPSBuZXcgTWVyZ2VyKGxlZnQsIGJhc2UsIHJpZ2h0KTtcbiAgICBtZXJnZXIuZXhlY3V0ZVRocmVlV2F5TWVyZ2UoKTtcblxuICAgIHJldHVybiBtZXJnZXIucmVzdWx0O1xuICB9XG5cbiAgcmVzdWx0OiBPdXRjb21lW107XG4gIHRleHQzOiBUZXh0MztcblxuICBjb25zdHJ1Y3RvcihsZWZ0OiBzdHJpbmdbXSwgYmFzZTogc3RyaW5nW10sIHJpZ2h0OiBzdHJpbmdbXSkge1xuICAgIHRoaXMucmVzdWx0ID0gW107XG4gICAgdGhpcy50ZXh0MyA9IG5ldyBUZXh0MyhsZWZ0LCBiYXNlLCByaWdodCk7XG4gIH1cblxuICBleGVjdXRlVGhyZWVXYXlNZXJnZSgpIHtcbiAgICBjb25zdCBkaWZmZXJlbmNlcyA9IERpZmYzLmV4ZWN1dGVEaWZmKHRoaXMudGV4dDMubGVmdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dDMuYmFzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dDMucmlnaHQpO1xuICAgIGxldCBpbmRleCA9IDE7XG5cbiAgICBkaWZmZXJlbmNlcy5mb3JFYWNoKChkaWZmZXJlbmNlKSA9PiB7XG4gICAgICBsZXQgaW5pdGlhbFRleHQgPSBbXTtcblxuICAgICAgZm9yKGxldCBsaW5lbm8gPSBpbmRleDsgbGluZW5vIDwgZGlmZmVyZW5jZS5iYXNlTG87IGxpbmVubysrKSB7XG4gICAgICAgIGluaXRpYWxUZXh0LnB1c2godGhpcy50ZXh0My5iYXNlW2xpbmVubyAtIDFdKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGluaXRpYWxUZXh0Lmxlbmd0aCkge1xuICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKG5ldyBSZXNvbHZlZChpbml0aWFsVGV4dCkpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmludGVycHJldENodW5rKGRpZmZlcmVuY2UpO1xuICAgICAgaW5kZXggPSBkaWZmZXJlbmNlLmJhc2VIaSArIDE7XG4gICAgfSk7XG5cblxuICAgIGNvbnN0IGVuZGluZ1RleHQgPSB0aGlzLmFjY3VtdWxhdGVMaW5lcyhpbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0My5iYXNlLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0My5iYXNlKTtcbiAgICBpZiAoZW5kaW5nVGV4dC5sZW5ndGgpIHtcbiAgICAgIHRoaXMucmVzdWx0LnB1c2gobmV3IFJlc29sdmVkKGVuZGluZ1RleHQpKTtcbiAgICB9XG4gIH1cblxuICBzZXRDb25mbGljdChkaWZmZXJlbmNlOiBEaWZmZXJlbmNlKSB7XG4gICAgY29uc3QgY29uZmxpY3QgPSBDb25mbGljdGVkLmNyZWF0ZSh7XG4gICAgICBsZWZ0OiB0aGlzLmFjY3VtdWxhdGVMaW5lcyhkaWZmZXJlbmNlLmxlZnRMbyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZlcmVuY2UubGVmdEhpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0My5sZWZ0KSxcbiAgICAgIGJhc2U6IHRoaXMuYWNjdW11bGF0ZUxpbmVzKGRpZmZlcmVuY2UuYmFzZUxvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZmVyZW5jZS5iYXNlSGksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHQzLmJhc2UpLFxuICAgICAgcmlnaHQ6IHRoaXMuYWNjdW11bGF0ZUxpbmVzKGRpZmZlcmVuY2UucmlnaHRMbyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlLnJpZ2h0SGksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0My5yaWdodClcbiAgICB9KTtcbiAgICB0aGlzLnJlc3VsdC5wdXNoKGNvbmZsaWN0KTtcbiAgfVxuXG4gIGRldGVybWluZUNvbmZsaWN0KGQ6IENoYW5nZVJhbmdlW10sIGxlZnQ6IHN0cmluZ1tdLCByaWdodDogc3RyaW5nW10pIHtcbiAgICBsZXQgaWEgPSAxO1xuICAgIGQuZm9yRWFjaCgoY2hhbmdlUmFuZ2UpID0+IHtcbiAgICAgIGZvcihsZXQgbGluZW5vID0gaWE7IGxpbmVubyA8PSBjaGFuZ2VSYW5nZS5sZWZ0TG87IGxpbmVubysrKSB7XG4gICAgICAgIHRoaXMucmVzdWx0LnB1c2gobmV3IFJlc29sdmVkKHRoaXMuYWNjdW11bGF0ZUxpbmVzKGlhLCBsaW5lbm8sIHJpZ2h0KSkpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBvdXRjb21lID0gdGhpcy5kZXRlcm1pbmVPdXRjb21lKGNoYW5nZVJhbmdlLCBsZWZ0LCByaWdodCk7XG4gICAgICBpYSA9IGNoYW5nZVJhbmdlLnJpZ2h0SGkgKyAxO1xuICAgICAgaWYgKG91dGNvbWUpIHtcbiAgICAgICAgdGhpcy5yZXN1bHQucHVzaChvdXRjb21lKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGxldCBmaW5hbFRleHQgPSB0aGlzLmFjY3VtdWxhdGVMaW5lcyhpYSwgcmlnaHQubGVuZ3RoICsgMSwgcmlnaHQpO1xuICAgIGlmIChmaW5hbFRleHQubGVuZ3RoKSB7XG4gICAgICB0aGlzLnJlc3VsdC5wdXNoKG5ldyBSZXNvbHZlZChmaW5hbFRleHQpKTtcbiAgICB9XG4gIH1cblxuICBkZXRlcm1pbmVPdXRjb21lKGNoYW5nZVJhbmdlOiBDaGFuZ2VSYW5nZSwgbGVmdDogc3RyaW5nW10sIHJpZ2h0OiBzdHJpbmdbXSkgOiBPdXRjb21lIHwgbnVsbCB7XG4gICAgaWYgKGNoYW5nZVJhbmdlLmFjdGlvbiA9PT0gQWN0aW9uLmNoYW5nZSkge1xuICAgICAgcmV0dXJuIENvbmZsaWN0ZWQuY3JlYXRlKHtcbiAgICAgICAgbGVmdDogdGhpcy5hY2N1bXVsYXRlTGluZXMoY2hhbmdlUmFuZ2UucmlnaHRMbywgY2hhbmdlUmFuZ2UucmlnaHRIaSwgbGVmdCksXG4gICAgICAgIHJpZ2h0OiB0aGlzLmFjY3VtdWxhdGVMaW5lcyhjaGFuZ2VSYW5nZS5sZWZ0TG8sIGNoYW5nZVJhbmdlLmxlZnRIaSwgcmlnaHQpLFxuICAgICAgICBiYXNlOiBbXVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VSYW5nZS5hY3Rpb24gPT09IEFjdGlvbi5hZGQpIHtcbiAgICAgIHJldHVybiBuZXcgUmVzb2x2ZWQodGhpcy5hY2N1bXVsYXRlTGluZXMoY2hhbmdlUmFuZ2UucmlnaHRMbyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlUmFuZ2UucmlnaHRIaSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBzZXRUZXh0KG9yaWdUZXh0OiBzdHJpbmdbXSwgbG86IG51bWJlciwgaGk6IG51bWJlcikge1xuICAgIGxldCB0ZXh0ID0gW107XG4gICAgZm9yKGxldCBpID0gbG87IGkgPD0gaGk7IGkrKykge1xuICAgICAgdGV4dC5wdXNoKG9yaWdUZXh0W2kgLSAxXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRleHQ7XG4gIH1cblxuICBfY29uZmxpY3RSYW5nZShkaWZmZXJlbmNlOiBEaWZmZXJlbmNlKSB7XG4gICAgY29uc3QgcmlnaHQgPSB0aGlzLnNldFRleHQodGhpcy50ZXh0My5yaWdodCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmZXJlbmNlLnJpZ2h0TG8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZmVyZW5jZS5yaWdodEhpKTtcbiAgICBjb25zdCBsZWZ0ID0gdGhpcy5zZXRUZXh0KHRoaXMudGV4dDMubGVmdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZlcmVuY2UubGVmdExvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZmVyZW5jZS5sZWZ0SGkpO1xuICAgIGNvbnN0IGQgPSBEaWZmMi5kaWZmKHJpZ2h0LCBsZWZ0KTtcbiAgICBpZiAoKHRoaXMuX2Fzc29jUmFuZ2UoZCwgQWN0aW9uLmNoYW5nZSkgfHwgdGhpcy5fYXNzb2NSYW5nZShkLCBBY3Rpb24ucmVtb3ZlKSkgJiZcbiAgICAgICAgZGlmZmVyZW5jZS5iYXNlTG8gPD0gZGlmZmVyZW5jZS5iYXNlSGkpIHtcbiAgICAgIHRoaXMuc2V0Q29uZmxpY3QoZGlmZmVyZW5jZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGV0ZXJtaW5lQ29uZmxpY3QoZCwgbGVmdCwgcmlnaHQpO1xuICAgIH1cbiAgfVxuXG4gIGludGVycHJldENodW5rKGRpZmZlcmVuY2U6IERpZmZlcmVuY2UpIHtcbiAgICBpZiAoZGlmZmVyZW5jZS5jaGFuZ2VUeXBlID09IENoYW5nZVR5cGUuY2hvb3NlTGVmdCkge1xuICAgICAgY29uc3QgdGVtcFRleHQgPSB0aGlzLmFjY3VtdWxhdGVMaW5lcyhkaWZmZXJlbmNlLmxlZnRMbyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZmVyZW5jZS5sZWZ0SGksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dDMubGVmdCk7XG4gICAgICBpZiAodGVtcFRleHQubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMucmVzdWx0LnB1c2gobmV3IFJlc29sdmVkKHRlbXBUZXh0KSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChkaWZmZXJlbmNlLmNoYW5nZVR5cGUgIT09IENoYW5nZVR5cGUucG9zc2libGVDb25mbGljdCkge1xuICAgICAgY29uc3QgdGVtcFRleHQgPSB0aGlzLmFjY3VtdWxhdGVMaW5lcyhkaWZmZXJlbmNlLnJpZ2h0TG8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZlcmVuY2UucmlnaHRIaSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0My5yaWdodCk7XG4gICAgICBpZiAodGVtcFRleHQubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMucmVzdWx0LnB1c2gobmV3IFJlc29sdmVkKHRlbXBUZXh0KSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2NvbmZsaWN0UmFuZ2UoZGlmZmVyZW5jZSk7XG4gICAgfVxuICB9XG5cbiAgX2Fzc29jUmFuZ2UoZGlmZjogQ2hhbmdlUmFuZ2VbXSwgYWN0aW9uOiBBY3Rpb24pIHtcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwgZGlmZi5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGQgPSBkaWZmW2ldO1xuICAgICAgaWYgKGQuYWN0aW9uID09PSBhY3Rpb24pIHtcbiAgICAgICAgcmV0dXJuIGQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBhY2N1bXVsYXRlTGluZXMobG86IG51bWJlciwgaGk6IG51bWJlciwgdGV4dDogc3RyaW5nW10pIHtcbiAgICBsZXQgbGluZXMgPSBbXTtcbiAgICBmb3IobGV0IGxpbmVubyA9IGxvOyBsaW5lbm8gPD0gaGk7IGxpbmVubysrKSB7XG4gICAgICBpZiAodGV4dFtsaW5lbm8tMV0pIHtcbiAgICAgICAgbGluZXMucHVzaCh0ZXh0W2xpbmVuby0xXSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBsaW5lcztcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVGV4dDMge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgbGVmdDogc3RyaW5nW10sXG4gICAgICAgICAgICAgIHB1YmxpYyBiYXNlOiBzdHJpbmdbXSxcbiAgICAgICAgICAgICAgcHVibGljIHJpZ2h0OiBzdHJpbmdbXSkge1xuICB9XG59XG4iXX0=